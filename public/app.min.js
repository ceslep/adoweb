"use strict";var imageFirma,socket=io(),url="/",dataUrl={},dataSelect=[],dadapor="";jQuery.fn.redraw=function(){return this.hide(0,function(){$(this).show()})},Date.prototype.toDateInputValue=function(){var t=new Date(this);return t.setMinutes(this.getMinutes()-this.getTimezoneOffset()),t.toJSON().slice(0,10)},$.fn.serializeObject=function(){var t={},a=this.serializeArray();return $.each(a,function(){t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t};var datosAgenda=[],filtrado=!1,datosCedula="",longCedula=0,arrayCedula=[],arrayCedulaStr=[],timeout=!1;const Keys=[48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,85,87,88,89,90,45,189];$(document).ready(()=>{const t=t=>{let a=["0","1","2","3","4","5","7","8","9"],e="";t.split("").map(t=>{t in a&&(e+=t)});return e};socket.on("data",t=>{}),longCedula=0;$("#btnFirmas").hide(),$("#inicio").hide(),$("#tableData").hide(),$("#frmLogin").submit(async t=>{t.preventDefault();let a=$("#frmLogin").serializeObject(),e=await fetch(url+"login",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}),o=await e.json();console.log(o),console.log(o[0].concedido),"Si"===o[0].concedido?($("#containerLogin").addClass("d-none"),$("#inicio").removeClass("height"),$("#containerLogin").hide(),$("#inicio").removeClass("d-none"),$("#tableData").removeClass("d-none"),$("#agenda").removeClass("d-none"),$("#inicio").show(),$("#tableData").show(),dadapor=o[0].nombres,i()):($("#nologinModal").modal("show"),$("#usuario").val(""),$("#password").val(""),$("#usuario").focus(),$("#infologin").removeClass("d-none"))}),$("#borraFirma").click(t=>{$("#myCanvas").css("background-image","none"),$("#myCanvas").clearCanvas()}),$("#btnFirma").click(t=>{imageFirma=$("#myCanvas").getCanvasImage(),$("#signature").val(imageFirma),console.log(imageFirma)}),$("#btnir").click(t=>{i()}),$("#btnGuardarEvolucion").click(async t=>{t.preventDefault(),console.log($("#frmEvolucion").serializeArray()),console.log($("#frmEvolucion").serialize()),console.log($("#frmEvolucion").serializeObject());var a="{";await $.each($("#frmEvolucion").serializeObject(),(t,e)=>{console.log(t,e),a+='"'+t+'":"'+e+'",'}),await $.each($("#frmRipsConsulta").serializeObject(),(t,e)=>{console.log(t,e),a+='"'+t+'":"'+e+'",'}),a=a.replace(/.$/,"}"),console.log(a);let e=await fetch(url+"guardaEvolucion",{method:"POST",body:a,headers:{"Content-Type":"application/json"}}),o=await e.json();console.log(o),"Ok"==o.Estado?$("#modalok").modal("show"):"Error"==o.Estado&&($("#infoUrl").text(`${o.Error}=>${o.Url}`),$("#errorcargaModal").modal("show")),$("#confirma2").modal("hide")}),$("#causa_externa").blur(t=>{console.log("fetch here")});$('a[data-toggle="tab"]').on("shown.bs.tab",async t=>{if(console.log($(t.target).text()),$("#btnFirmas").hide(),"R.I.P.S."==$(t.target).text()){$("#spinner").show();let t=await fetch(url+"causa_externa",{method:"POST",body:JSON.stringify({database:$("#database").val(),tipo:$("#especialidad").val()}),headers:{"Content-Type":"application/json"}}),a=await t.json(),e="";await a.forEach(t=>{e+=`<option value="${t.codigo}:${t.nombre}">${t.nombre}</option>`}),$("#causa_externa_list").empty().html(e),t=[],t=await fetch(url+"diagnosticos",{method:"POST",body:JSON.stringify({database:$("#database").val(),tipo:$("#especialidad").val()}),headers:{"Content-Type":"application/json"}});let o=await t.json();e="",await o.forEach(t=>{e+=`<option value="${t.codigo}:${t.diagnostico}">${t.diagnostico}</option>`}),$("#diagnostico_principal_list").empty().html(e),$("#diagnostico_relacionado1_list").empty().html(e),$("#diagnostico_relacionado2_list").empty().html(e),$("#diagnostico_relacionado3_list").empty().html(e),$("#spinner").hide()}else if("Historial"==$(t.target).text()){let t=await fetch(url+"getHistorial",{method:"POST",body:JSON.stringify({paciente:$("#paciente").val(),database:$("#database").val(),tipo:$("#especialidad").val()}),headers:{"Content-Type":"application/json"}}),a=await t.json();console.log(a);let e='<div class="accordion" id="historialAccordion">';a.forEach(t=>{e+='<div class="card">',e+=`<div class="card-header" id="heading${t.ind}">`,e+='<h5 class="mb-0">',e+=`<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse${t.ind}" aria-expanded="true" aria-controls="collapse${t.ind}">`,e+='<div class="row">',e+='<div class="col-sm-8">',e+=`${t.fecha} &#8594; ${t.nombre}`,e+="</div>",e+='<div class="col-sm-4">',e+=(t=>"S"==t?'<img src="imagenes/asistio.png" alt="Asistió" class="img-thumbnail imagen-asistio">':'<img src="imagenes/no_asistio.png" alt="Asistió" class="img-thumbnail imagen-asistio">')(t.asistio),e+="</div>",e+="</div>",e+="</button>",e+="</h5>",e+="</div>",e+=`<div id="collapse${t.ind}" class="collapse" aria-labelledby="heading${t.ind}" data-parent="#historialAccordion">`,e+='<div class="card-body">',e+='<ul class="list-group bg-secondary text-dark">',Object.keys(t).forEach(a=>{e+=`<li class="list-group-item list-group-item-success">${a} &#8594; ${t[a]}</li>`}),e+="</ul>",e+="</div>",e+="</div>",e+="</div>"}),e+="</div>",$("#nav-history").empty().html(e)}else if("Firma Touch"==$(t.target).text())$("#btnFirmas").show();else if("Evoluciones"==$(t.target).text()){console.log("evoluciones");let t=await fetch("/evoluciones",{method:"POST",body:JSON.stringify({database:`${$("#database").val()}`,paciente:`${$("#paciente").val()}`}),headers:{"Content-Type":"application/json"}}),a=await t.json(),e='<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">',o=1;a.forEach(t=>{e+=`\n\t\t\t\t<div class="panel-heading" role="tab" id="heading${o}">\n\t\t\t\t\t<h4 class="panel-title">\n\t\t\t\t\t\t<a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapse${o}" aria-expanded="false" aria-controls="collapse${o}">\n\t\t\t\t\t\t${t.fecha} &#8594; ${t.procedimiento}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</h4>\n\t\t\t\t</div>\n\t\t\t\t\t\t<div id="collapse${o}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading${o}">\n\t\t\t\t\t\t\t<div class="panel-body">\n\t\t\t\t\t\t\t\t<p>body</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="panel-footer">info</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t`}),e+="</div>",$("#nav-evoluciones").empty().html(e)}}),(async()=>{const t=await fetch(url+"url"),a=await t.json();console.log(a.servidor),$("#infoUrl").text(a.servidor)})(),(async()=>{try{const t=await fetch(url+"databases"),a=await t.json();console.log(a);let e="<option></option>";if(console.log(a.message),null!=a.message)return $("#infoUrl").text(`${a.message}=>${a.errno}.No se ha podido conectar con el servidor ${$("#infoUrl").text()}`),void $("#errorcargaModal").modal("show");await a.forEach(t=>{for(var a in t)e+=`<option value="${t[a]}">${t[a]}</option>`}),$("#database").empty().html(e)}catch(t){console.error(t)}})();$("#database").change(t=>{(async()=>{const t=await fetch(url+"especialidades",{method:"POST",body:JSON.stringify({database:$("#database").val()}),headers:{"Content-Type":"application/json"}}),a=await t.json();if(console.log(a),null!=a.Tipo)$("#bodyError").html(`<span class="text-danger">${a.Mensaje}</span>`),$("#errorEspecialidades").modal("show");else{console.log(a);let t="<option></option>";await a.forEach(a=>{t+=`<option value="${a.nombre}">${a.descripcion}</option>`}),$("#especialidad").empty().html(t)}})()}),$("#fechaAgenda").val((new Date).toDateInputValue());const a=async()=>{$("#spinner").show();const t=await(async()=>{try{let t={fecha:$("#fechaAgenda").val(),database:$("#database").val(),tipo:$("#especialidad").val()};console.log(t);const a=await fetch(url+"citas",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});return await a.json()}catch(t){console.error(t),$("#errorcargaModal").modal("show")}})();return console.log(t),$("#spinner").hide(),t},e=async()=>{$("#spinner").show();const t=await(async()=>{try{let t={fecha:$("#fechaAgenda").val(),database:$("#database").val(),tipo:$("#especialidad").val()};const a=await fetch(url+"agenda",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});return await a.json()}catch(t){console.error(t)}})();return console.log(t),$("#spinner").hide(),t};const o=async t=>{let a="";return console.log(t),await t.forEach(t=>{let e="row"+t.vhoras;e=e.trim(),a+=`<tr class="text-dark" id="${e}" \n\t\t\t\t\t   data-paciente="${t.paciente}"\n\t\t\t\t\t   data-identificacion="${t.identificacion}"\n\t\t\t\t\t   data-cara="${t.cara}"\n\t\t\t\t\t   data-citasind="${t.citasind}"\n\t\t\t\t\t   data-telefono="${t.telefono}"\n\t\t\t\t\t   \n\t\t\t\t\t   >\n\t\t\t<td  style="background:${t.color}">\n\n\t\t\t  <h4 class="${""!=t.nombres?"text-dark":"text-white"}">${t.vhoras}</h4>\n\t\t\t</td> \n\t\t\t<td style="background:${t.color}">\n\t\t\t  \n\t\t\t  <div class="row">\n\t\t\t  \t\t<div class="col-sm-6"><h4>${t.nombres}</h4></div>\n\t\t\t\t\t  <div class="col-sm-3 text-center">${function(t){return null!=t&&""!=t?`<img class="cara" src='caras/${t.toLowerCase()}.png'>`:""}(t.cara)}</div>\n\t\t\t\t\t \n\t\t\t\t</div>\n\t\t\t</td>\n\t\t\t<td style="background:${t.color}">\n\t\t\t  <h4>${t.procedimiento}</h4>\n\t\t\t</td>\n\t\t  </tr>`}),a},i=async(t=!1)=>{console.log("Cargando Datos de Citas "),$("#infoSpinner").text("Cargando Datos de Citas");const i=await a();console.log("Cargando Datos de Agenda "),$("#infoSpinner").text("Cargando Datos de Agenda"),$("#spinner").addClass("text-secondary"),datosAgenda=await e(),$("#agenda").redraw(),await(async t=>{console.log(t),await t.forEach(t=>{var a=t.vhoras.substring(0,5)+"."+t.consultorio,e=datosAgenda.findIndex(function(t,e){return t.vhoras===a});null!=datosAgenda[e]&&(datosAgenda[e].nombres=t.nombres,datosAgenda[e].procedimiento=t.procedimiento,datosAgenda[e].color=t.style)})})(i),$("#dataInfo").empty().html(await o(datosAgenda)),filtrado=!t,t||$("#filtrar").click()};function n(t){var a=t.target,e=(parseFloat(a.getAttribute("data-x"))||0)+t.dx,o=(parseFloat(a.getAttribute("data-y"))||0)+t.dy;a.style.webkitTransform=a.style.transform="translate("+e+"px, "+o+"px)",a.setAttribute("data-x",e),a.setAttribute("data-y",o)}$("#filtrar").click(async t=>{if(filtrado=!filtrado){var a=datosAgenda.filter(t=>""!=t.nombres);$("#dataInfo").empty().html(await o(a))}else $("#dataInfo").empty().html(await o(datosAgenda))}),$(".cimage > img").click(t=>{t.preventDefault();let a=$(t.currentTarget);$("#fotop2").attr("src",a.attr("src")),-1==a.parent().siblings(".modal-title").text().trim().indexOf("Cita")?$("#fotoModalCenterTitle").text(a.parent().siblings(".modal-title").text().trim()):$("#fotoModalCenterTitle").text($("#pacientes option:selected").data("nombres")),$("#fotoModalCenter").modal().modal("show")}),$(document).on("click","tr",async a=>{var e=$(a.currentTarget);console.log(e),$("#btnFirmas").hide(),$(window).width()<600?$("#nav-signature-tab").hide():$("#nav-signature-tab").show();let o=await e.children().filter((t,a)=>1==t);if(console.log(o.text().trim()),""!=o.text().trim()){$(".nav-tabs a:first").tab("show"),$("#paciente").val(e.data("paciente")),$("#identificacion").val(e.data("identificacion")),$("#cara").val(e.data("cara")),$("#citasind").val(e.data("citasind")),$("#fechaEvolucion").val($("#fechaAgenda").val()),$("#hora").val((new Date).toLocaleTimeString("es-ES")),$("#confirma2LongTitle").text(o.text()),$("#sigStringData").hide(),$("#sigImageData").hide(),$("#SigImg").hide(),$("#tipo").val($("#especialidad").val()),$("#gdb").val($("#database").val()),$("#whatsapp").attr("href",`https://api.whatsapp.com/send?phone=${t(e.data("telefono"))}?text=Hola%20te%20escribo%20desde%20la%20clinica%20Moya%20Ortodoncia`),$("#telefono").attr("href",`tel://${t(e.data("telefono"))}`),$("#sms").attr("href",`sms:+57${t(e.data("telefono"))}`);let a=await fetch("/foto",{method:"POST",body:JSON.stringify({database:$("#database").val(),paciente:$("#paciente").val()}),headers:{"Content-Type":"application/json"}}),i=await a.json();$("#fotop1").attr("src",i[0].foto),$("#confirma2").modal("show")}else{$("#fechaCita").val($("#fechaAgenda").val());let t=await e.children().filter((t,a)=>0==t);$("#horasCita").val(t.text().trim()),$("#asignaCitaModalLabel").html("Asignar Cita"),$("#asignaCitaModalLabel").html($("#asignaCitaModalLabel").text()+` <i class="far fa-arrow-alt-circle-right" style="color:orange;"></i> ${$("#fechaCita").val()}`+" : <span style='color:aqua;'>"+t.text().trim()+"</span>"),async function(){$("#mapa").chosen("destroy"),$("#pacientes").chosen("destroy"),$("#procedimientos").chosen("destroy"),$("#spp0").removeClass("d-none"),$("#spp").removeClass("d-none"),$("#sppr").removeClass("d-none"),console.log("Fetch");let t=await fetch(url+"maps",{method:"POST",body:JSON.stringify({database:$("#database").val()}),headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},mode:"cors"}),a=await t.json(),e="<option value='Todos'>Todos</option>";a.forEach(t=>{e+=`<option value="${t.auxiliar}">${t.nombresp}:${t.map}</option>`}),$("#mapa").empty().html(e),$("#mapa").chosen({disable_search_threshold:10,allow_single_deselect:!0,width:"100%"}),t=await fetch(url+"pacientes",{method:"POST",body:JSON.stringify({database:$("#database").val()}),headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},mode:"cors"});let o=await t.json();console.log(o),$("#labelPacientes").text(`(Total de Pacientes de ${$("#mapa option:selected").text()} es ${o.length})`),e="<option></option>",o.forEach(t=>{e+=`<option value="${t.historia}:${t.nombres}:${t.identificacion}" data-nombres="${t.nombres}" data-historia="${t.historia}" data-est="${t.estado_paciente}">${t.historia}:${t.nombres}:${t.identificacion}</option>`}),$("#pacientes").empty().html(e),$("#pacientes").chosen({no_results_text:"Lo siento no pude encontrar el paciente Buscado",allow_single_deselect:!0}),t=[],t=await fetch(url+"procedimientos",{method:"POST",body:JSON.stringify({database:$("#database").val(),tipo:$("#especialidad").val()}),headers:{"Content-Type":"application/json"}});let i=await t.json();e="<option></option>",await i.forEach(t=>{e+=`<option value="${t.codigo}:${t.nombre}" data-duracion="${t.duracion}">${t.codigo}:${t.nombre}:${t.duracion}</option>`}),await $("#procedimientos").empty().html(e),$("#procedimientos").chosen({no_results_text:"Lo siento no pude encontrar el procedimiento Buscado",allow_single_deselect:!0}),$("#mapa").trigger("chosen:updated"),$("#procedimientos").trigger("chosen:updated"),$("#pacientes").trigger("chosen:updated"),$("#spp0").addClass("d-none"),$("#spp").addClass("d-none"),$("#sppr").addClass("d-none")}(),$("#asignaCitaModal").modal({backdrop:"static",keyboard:!1}).modal("show")}}),$("#reintentar").click(t=>{location.reload()}),$("#buscarBtn").click(async t=>{if(t.preventDefault(),""==$("input[type='search']").val())return;let a=$("input[type='search']").val().toUpperCase(),e=datosAgenda.filter(t=>-1!=t.nombres.indexOf(a));console.log(e),$("#dataInfo").empty().html(await o(e))}),$("input[type='search']").on("input",t=>{console.log($(t.currentTarget).val()),$("#buscarBtn").click()}),$("#clear").click(t=>{ClearTablet()}),window.onunload=window.onbeforeunload=function(){},$("#fechaAgenda").change(async t=>{$("#spinner").show(),i(),$("#spinner").hide(),$("#filtrar").click()}),$("#cuadre").click(async t=>{$("#cuadreTabla").show(),$(".loadingCuadre").removeClass("d-none");let a=await fetch("/cuadre",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await a.json();var o="<table class='table table-striped table-bordered table-hover'>";o+="<thead class='thead-dark'>",o+="<tr>",Object.keys(e[0]).forEach(t=>{o+=`\n\t\t\t\t\t\t\t<th>\n\t\t\t\t\t\t\t\t${t}\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t`}),o+="</tr>",o+="</thead>",o+="<tbody>",e.forEach(t=>{o+="<tr>",Object.keys(t).forEach(a=>{o+=`\n\t\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t\t${t[a]}\n\t\t\t\t\t\t\t\t\t</td>\t\n\t\t\t\t\t\t\t\t`}),o+="</tr>"}),o+="</tbody>",o+="</table>",console.log(o),$("#tableData").hide(),$("#cuadreTabla").empty().html(o),$(".navbar-toggler").click()}),$("#mapa").chosen().change(async t=>{$("#spp").removeClass("d-none"),$("#pacientes").chosen("destroy"),console.log($(t.currentTarget).val());let a=await fetch(url+"pacientes",{method:"POST",body:JSON.stringify({database:$("#database").val(),mapa:$(t.currentTarget).val()}),headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},mode:"cors"}),e=await a.json();console.log(e),$("#labelPacientes").text(`(Total de Pacientes de ${$("#mapa option:selected").text()} es ${e.length})`);let o="<option></option>";e.forEach(t=>{o+=`<option value="${t.historia}:${t.nombres}:${t.identificacion}" data-nombres="${t.nombres}" data-historia="${t.historia}" data-est="${t.estado_paciente}">${t.historia}:${t.nombres}:${t.identificacion}</option>`}),$("#pacientes").empty().html(o),$("#pacientes").chosen({no_results_text:"Lo siento no pude encontrar el paciente Buscado",allow_single_deselect:!0}),$("#pacientes").trigger("chossen:updated"),$("#spp").addClass("d-none")}),$("#pacientes").chosen().change(async t=>{let a=$("#pacientes option:selected").data("historia");console.log(a);let e=await fetch("/foto",{method:"POST",body:JSON.stringify({database:$("#database").val(),paciente:a}),headers:{"Content-Type":"application/json"}}),o=await e.json();console.log(o),$(".cimage").removeClass("d-none");try{$("#fotop3").attr("src",o[0].foto)}catch{$(".cimage").addClass("d-none")}}),$("#asignaCitaModal").on("shown.bs.modal",async t=>{}),interact("#asignaCitaModal").draggable({inertia:!0,modifiers:[interact.modifiers.restrictRect({restriction:"none",endOnly:!0})],autoScroll:!0,listeners:{move:n,end(t){var a=t.target.querySelector("p");a&&(a.textContent="moved a distance of "+Math.sqrt(Math.pow(t.pageX-t.x0,2)+Math.pow(t.pageY-t.y0,2)|0).toFixed(2)+"px")}}}),window.dragMoveListener=n;$("#frmAsignaCita").submit(async t=>{t.preventDefault();let a=$("#pacientes").val(),e=$("#procedimientos").val();if(""==a||""==e)$("#errorPaciente").modal({backdrop:"static",keyboard:!1}).modal("show");else{let e=$("#pacientes option:selected").data("est");console.log(e),"PACIENTE"==e?$("#ctable").val("citas"):$("#ctable").val("cppre"),console.log($("#ctable"));let n=a.indexOf(":");$("#pacienteCita").val(a.trim().substring(0,n));let s=(t=>t.split("").reverse().join(""))(a).indexOf(":");$("#identificacionCita").val(a.trim().substring(a.length-s,a.length));let l=(a=$("#procedimientos").val()).indexOf(":");$("#procedimientoCita").val(a.trim().substring(0,l));let r=$("#procedimientos option:selected").data("duracion");$("#duracionCita").val(r);let c=$("#horasCita").val();console.log(c),$("#horasCita").val($("#horasCita").val().substring(0,5)),$("#vhorasCita").val($("#horasCita").val()+":00"),$("#consultorioCita").val(c.substring(c.length-1,c.length)),$("#frmDatabase").val($("#database").val());let d=parseInt(c.substring(0,2));d<12?$("#horasCita").val($("#horasCita").val()+" am"):(d-=12,$("#horasCita").val((d<9?"0"+d:d)+":"+c.substring(3,5)+" pm")),$("#fecha_pide_cita").val((new Date).toDateInputValue());let p=new Date;$("#hora_pide_cita").val(`${p.getHours()<10?"0"+p.getHours():p.getHours()}:${p.getMinutes()<10?"0"+p.getMinutes():p.getMinutes()}:${p.getSeconds()<10?"0"+p.getSeconds():p.getSeconds()}`),$("#dadapor").val(dadapor),$("#frmTipo").val($("#especialidad").val());let h=$(t.currentTarget).serializeObject();var o="{";await $.each(h,(t,a)=>{o+='"'+t+'":"'+a+'",'}),o=o.replace(/.$/,"}"),console.log(o);let g={database:$("#database").val(),fecha:$("#fechaCita").val(),hora:$("#vhorasCita").val(),procedimiento:$("#procedimientoCita").val(),consultorio:$("#consultorioCita").val(),tipo:$("#frmTipo").val()};g=JSON.stringify(g),console.log(g);let m=await fetch("/cabecita",{method:"POST",body:g,headers:{"Content-Type":"application/json"}}),u=await m.json();if(console.log(u),"Si"==u[0].Cabe){let t=await fetch(url+"guardaCita",{method:"POST",body:o,headers:{"Content-Type":"application/json"}}),a=await t.json();console.log(a),$("#asignaCitaModal").modal("hide"),i(!0)}else $("#cabecita").modal({backdrop:"static",keyboard:!1}).modal("show")}})});